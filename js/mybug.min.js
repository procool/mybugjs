var myBug=function(h,f){if(!f){f={}}if(!f.queue_interval){f.queue_interval=10}if(!f.speed){f.speed=30}if(!f.step_size){f.step_size=3}if(!f.rand_direction_diff){f.rand_direction_diff=80}if(!f.rand_direction_chance){f.rand_direction_chance=4/5}if(!f.min_queue&&f.min_queue!=0){f.min_queue=5}if(!f.debug){f.debug=0}var d=function(){this.$wrap=$('<div class="'+this.class_prefix+'wrapper"></div>');this.$wrap.hide();this.is_visible=false;this.step_size=f.step_size;this.speed=f.speed;this.fadein=f.fadein;this.fadeout=f.fadeout;this.min_queue=f.min_queue;this.rnd_dir_diff=parseInt(f.rand_direction_diff/2)*2;this.rand_direction_chance=f.rand_direction_chance;this.$img=$('<div class="'+this.class_prefix+'img"></div>');this.initialized=false};var e=d.prototype;e.cname="mybug";e.class_prefix="mybug-";var g=[0,-14,-25,-36,-47,-60,-72,-85,-97];var c=20;function a(i){return(i*Math.PI)/180}function b(i){if(i>360){i=i-360}if(i<0){i=360+i}return i}e.init=function(){if(this.initialized){return}this.$wrap.append(this.$img);h.append(this.$wrap);this.set_max_xy();this._mouse_history=[];this._go_queue=[];this.make_random_offset();this.direction=parseInt(Math.random()*360);this.initialized=true};e.set_max_xy=function(){this.max_h=h.outerHeight(true)-100;this.max_w=h.outerWidth(true)-100;if(this.max_h<=10){this.max_h=document.body.clientHeight}if(this.max_w<=10){this.max_w=document.body.clientWidth}if(this.max_h<=10){this.max_h=screen.height}if(this.max_w<=10){this.max_w=screen.width}};e._draw_img_count=function(i){this.$img.css("background-position","0px "+g[i]+"px")};e._draw_img_next=function(){if(!this._img_count||this._img_count>=9){this._img_count=0}this._draw_img_count(this._img_count);this._img_count+=1;if(f.on_step){f.on_step.call(this,this.direction,this.offset)}};e.draw=function(i){this.init();if(!i){i=this.offset}if(i!=this.offset){this.offset=i}this.$wrap.offset(i);this._draw_img_next()};e.show=function(j,i){this.is_visible=true;this.draw(j);if(i){this.$wrap.fadeIn(i)}else{this.$wrap.show()}if(f.on_show){f.on_show.call(this)}};e.hide=function(i){this.is_visible=false;if(i){this.$wrap.fadeOut(i)}else{this.$wrap.hide()}if(f.on_hide){f.on_hide.call(this)}};e.make_random_offset=function(){this.offset={left:parseInt((this.max_w-20)*Math.random())+20,top:parseInt((this.max_h-20)*Math.random())+20}};e.run=function(j){if(!j&&j!=0){j=this.direction}if((this.offset.left<=10||this.offset.top<=10)||(this.offset.left>=this.max_w+10||this.offset.top>=this.max_h+10)){j+=180}j=b(j);if(j!=this.direction){this.$wrap.css({transform:"rotate("+j+"deg)"})}var i=this.step_size;this.offset.left+=parseInt(i*Math.cos(a(j)));this.offset.top+=parseInt(i*Math.sin(a(j)));this.$wrap.offset(this.offset);this.direction=j;this._draw_img_next()};e.run_random=function(){var k=Math.random()>this.rand_direction_chance?true:false;var j=this.direction;if(k){var i=parseInt(Math.random()*this.rnd_dir_diff)-(this.rnd_dir_diff/2);j+=i;j=b(j);if(f.debug>=3){console.log("NEW DIRECTION DEG: "+j)}if(!this.$img.outerHeight(false)){return}}this.run(j)};e.start=function(){var i=this;this.iv_go_queue_running_check=setInterval(function(){i.set_max_xy();i.go_queue_run()},f.queue_interval);return this};e.stop=function(){if(this.iv_go_queue_running_check){clearInterval(this.iv_go_queue_running_check)}return this};e.runto=function(k,m,j,i,l){if(!i){i=0}if(this._go_queue.length>=c){this._go_queue.splice(0,this._go_queue.length-c)}this._go_queue.push([i,m,k,j,l])};e.go_queue_run=function(){if(this.min_queue&&this.$img.is(":hidden")&&this._go_queue.length<this.min_queue){return}if(this._go_queue.length==0){return}if(this.iv_random_mouse_running&&this._go_queue.length==1&&this.is_visible){this.hide(this.fadeout)}else{if(this.iv_random_mouse_running&&!this.is_visible&&this.$img.is(":hidden")){this.make_random_offset();this.show(null,this.fadein)}}if(this._go_queue_runing){return}this._go_queue_runing=true;var i=this._go_queue.shift();if(f.debug>=1){console.log("myBug: QUEUE LENGTH: "+this._go_queue.length)}var k=i[2];var j=i[3]||this.speed;var l=this;setTimeout(function(){if(f.on_action){f.on_action.call(l,i[1],k,j)}l._go_queue_run(i[1],k,j,i[4])},i[0])};e._go_queue_run=function(n,k,m,p){var j=0;var i=null;var o=this;if(f.debug>=1){console.debug("RUNNING DISTANCE: "+n+" STEPS")}var l=function(){j+=1;if(j>=n){clearInterval(i);o._go_queue_runing=false;if(p){p.call(o)}}if(!k&&k!=0){o.run_random()}else{o.run(k)}};i=setInterval(l,m)};e.start_random_mouse_running=function(){var s=3000,t=400,p=0.5,i=1/7,r=20,q=300;this.init();var m=this;var l=5000;this.iv_random_mouse_running=setInterval(function(){var u=0;var w=0;var y=0;for(var x in m._mouse_history){u+=(m._mouse_history[x][1]+m._mouse_history[x][2]);w+=(y==0?0:m._mouse_history[x][0]-y);y=m._mouse_history[x][0];if(w>t){w=w*p;if(s>0&&w>s){w=s}var v=parseInt(u*i);if(q>0&&v>q){v=q}if(v<r){v=r}m.runto(null,v,null,w);u=0;w=0}}m._mouse_history.length=0},l);var o=cacheX=0;var n=cacheY=0;var k;var j=0;$(document).on("mousemove",function(u){if(!u){u=event}cacheX<u.clientX?o+=u.clientX-cacheX:o+=cacheX-u.clientX;cacheY<u.clientY?n+=u.clientY-cacheY:n+=cacheY-u.clientY;cacheX=u.clientX;cacheY=u.clientY;if(k){j+=new Date().getTime()-k}else{k=new Date().getTime()}if(j>t){m._mouse_history.push([new Date().getTime(),o,n]);o=n=0}})};e.stop_random_mouse_running=function(){if(this.iv_random_mouse_running){clearInterval(this.iv_random_mouse_running)}};return new d};